# Packer Builder for Orka

This is a [Packer Builder] to automate building images for [MacStadium Orka] a Kubernetes/Docker-based macOS virtualization SaaS service by [MacStadium].

### Compatibility

For this plugin to function you need to have at least Packer 1.6.0 installed and Orka CLI 1.3.0.

 * [Packer Downloads] - 1.6.0+
 * [Orka CLI Downloads] - 1.3.0+

## Install / Setup

1. Install [Packer](https://www.packer.io/downloads.html)
2. Install [Orka CLI](https://orkadocs.macstadium.com/docs/downloads)
3. Setup Orka CLI - See: [Orka Setup Guide]
3. Download the [Latest Release] of this plugin.
4. Unzip the plugin binaries to a location where [Packer] will detect them at run-time, such as any of the following:
    * The directory where the [packer] binary is.
    * The `~/.packer.d/plugins` directory.
    * The current working directory.
5. Change to a directory where you have [packer] templates, and run as usual.

## Packer Builder Configuration

```json
{
  "builders": [{
    "type": "macstadium-orka",
    "source_image": "name-of-image-from-vm-images-list",
    "image_name": "destination-image-name"
  }]
}
```
---

* `type` _(string)_ **(required)**

Must be `macstadium-orka`

* `source_image` _(string)_ **(required)**

This is the source image (vm config) we will be using to launch the VM from.  This should be an entry from `orka vm configs`.  If you don't have one or need to create one, here's an example.  The "base-image" in the below command is looked up from `orkaÂ image list`.  See [examples below](#Example-Commands)

* `image_name` _(string)_ (optional)

This is the destination name of the image that will be created.  The image will be located inside `orka image list` when completed.  If not specified this will be autogenerated to the following: `packer-{{unix timestamp}}`

* `do_not_delete` _(boolean)_ (optional) _*- for devs*_

By default this plugin automatically deletes the VM afterwards if all scripts ran successfully.  AFAIK there is no mechanism built-into Packer to "force" it to not delete the source VM afterwards, so this fills that gap.  This is useful for debugging builds that are being weird, but is generally not intended for noraml use.  You should just use the resulting image.

* `simulate_create` _(boolean)_ (optional) _*- for devs*_

This is for internal development purposes, to prevent having to constantly create VMs for testing/development of this plugin.  Not for normal use.

## Information Notes / Gotchas

[MacStadium Orka] base images have SSH enabled by default and the username/password is `admin:admin` because they are within' a private network by default.  So this plugin has those credentials hardcoded by default, but you can of course customize the communicator.  See the options from the [SSH Communicator].

## Example Commands

```bash
# Create a config which is used for source_image above
orka vm create-config -v macos-catalina-10-15-5 -c 3 --C 3 --vnc --base-image macos-catalina-10.15.5.img -y

# In essence, this plugin automates running the following 3 commands...

# Start a VM (using the config above)
orka vm deploy -v macos-catalina-10-15-5 --vnc -y

# Stop and remove a VM
orka vm delete --vm base-image-catalina -y

# Save a VM's disk to a disk image
orka image save -v <vmid-here-from-orka-vm-list> -b <destination-image-name> -y

# Once you're done working with an image and want to delete
orka image delete --image <destination-image-name> -y

# Or alternatively, use that image in a future config (orka vm create-config) to launch future VMs based on that image
```

## Changelog / History

[1.0.0] - Initial Release, basic functionality wrapper around Orka CLI

## Development / Bugs

If you want to help contribute to this plugin or find a bug, please file an issue on Github, and/or submit me a PR.

To get a development environment up will need a recent golang installed and setup.  Then with a single make command below command it will build, install, and try to run the example at [examples/macos-catalina.json](./examples/macos-catalina.json).  You may need to edit this file to have the source VM config that you have locally, as it is hardcoded to my environment's image `macos-catalina-10-15-5` at the moment.

```bash
make fresh
```

## Todo (in no particular order)

 * Add tests
 * Add image management features into the builder instead of having to manage out-of-band with orka cli (eg: delete image)
 * Migrate to the (as of yet) undocumented Orka API.  Maybe MacStadium will help?  This will simplify the code greatly, and remove the reliance on the Orka CLI to be pre-installed and pre-configured.  Although, arguably this may make this more complicated because then you need to specify the API Key/Token/Account information into this plugin.
 * Clean up / improve code / catch more sharp edges and edge-cases

## Original Author / License

* Written by [Farley Farley] ( farley _at_ neonsurge *dot* com )
* License Terms: [GNU GPL v3]


[//]: <> (Ignore, below here are links for ease-of-use above)
[Packer]: https://www.packer.io/
[Packer Builder]: https://www.packer.io/docs/extending/custom-builders.html
[MacStadium Orka]: https://www.macstadium.com/orka
[Orka]: https://www.macstadium.com/orka
[MacStadium]: https://www.macstadium.com
[Packer Downloads]: https://www.packer.io/downloads.html
[Orka CLI Downloads]: https://orkadocs.macstadium.com/docs/downloads
[Orka Setup Guide]: https://orkadocs.macstadium.com/docs/quick-start
[Latest Release]: https://github.com/andrewfarley/packer-builder-macstadium-orka/releases
[Farley Farley]: https://github.com/andrewfarley
[GNU GPL v3]: https://choosealicense.com/licenses/gpl-3.0/
[1.0.0]: https://github.com/andrewfarley/packer-builder-macstadium-orka/releases/tag/v1.0.0
[SSH Communicator]: https://www.packer.io/docs/communicators/ssh